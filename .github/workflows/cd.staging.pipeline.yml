name: "[STAGING] CI & CD EV [BE]"

env:

  # Backend deployment folder on the server
  DEPLOY_FOLDER: /home/github-runner/ev-hub/backend/source

  # ENV file path on the server
  ENV_FILE_PATH: /home/github-runner/ev-hub/backend/env_file/.env

  # Image name for the Docker container
  IMAGE_NAME: ev:${{ github.ref_name }}-${{ github.sha }}

  # Container name for the service
  CONTAINER_NAME: ev

  # Docker Compose file path
  DOCKER_COMPOSE_PATH: ./docker-compose.yml

  # The filename for the Docker image artifact
  IMAGE_FILENAME: ev.tar

  # Dockerfile path
  DOCKERFILE_PATH: ./Dockerfile

  PROJECT_NAME: "EV HUB [BE]"

  # Test server
  TEST_SERVER: http://localhost:3923

on:
  push:
    branches:
      - staging

jobs:
  build_and_publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Notify Discord - Starting Deployment
        uses: ./.github/actions/notify-discord
        with:
          content: "üöÄ [UAT] Starting deployment of ${{ env.PROJECT_NAME }}..."
          bot_token: ${{ secrets.DISCORD_TOKEN }}
          channel: ${{ secrets.DISCORD_CHANNEL }}

      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }} -f ${{ env.DOCKERFILE_PATH }} .

      - name: Save Docker image to a tar file
        run: docker save -o ${{ env.IMAGE_FILENAME }} $IMAGE_NAME

      - name: Make image file readable
        run: chmod 644 ${{ env.IMAGE_FILENAME }}

      - name: Copy Docker image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "${{ env.IMAGE_FILENAME }}"
          target: "/tmp" # Copy to a temporary directory on the server

      - name: Clean old docker compose script and old env file
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            rm -rf ${{ env.DEPLOY_FOLDER }}/*

      - name: Copy new docker compose script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: ${{ env.DOCKER_COMPOSE_PATH }}
          target: ${{ env.DEPLOY_FOLDER }}

      - name: Notify Discord - Starting Deployment
        uses: ./.github/actions/notify-discord
        with:
          content: "üöÄ Starting deployment of ${{ env.PROJECT_NAME }}..."
          bot_token: ${{ secrets.DISCORD_TOKEN }}
          channel: ${{ secrets.DISCORD_CHANNEL }}

  deploy:
    runs-on: ubuntu-latest
    needs: build_and_publish

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            cp ${{ env.ENV_FILE_PATH }} ${{ env.DEPLOY_FOLDER }}
            cd ${{ env.DEPLOY_FOLDER }}

            echo "Loading new image from tar file..."

            docker load -i /tmp/${{ env.IMAGE_FILENAME }}

            if [ "$(docker ps -aq -f name=^${{ env.CONTAINER_NAME }}$)" ]; then
                docker compose -f ${{ env.DOCKER_COMPOSE_PATH }} down ${{ env.CONTAINER_NAME }}
            fi

            echo "Waiting for new container: ${{ env.CONTAINER_NAME }} to pull..."

            IMAGE_VERSION=${{ github.ref_name }}-${{ github.sha }} docker compose -f ${{ env.DOCKER_COMPOSE_PATH }} pull ${{ env.CONTAINER_NAME }}

            echo "Start new container: ${{ env.CONTAINER_NAME }}..."

            IMAGE_VERSION=${{ github.ref_name }}-${{ github.sha }} docker compose -f ${{ env.DOCKER_COMPOSE_PATH }} up -d ${{ env.CONTAINER_NAME }}

#      - name: Trigger API Tests
#        if: success()
#        uses: appleboy/ssh-action@v1.1.0
#        with:
#          host: ${{ secrets.SERVER_HOST }}
#          username: ${{ secrets.SERVER_USER }}
#          password: ${{ secrets.SERVER_PASSWORD }}
#          port: 22
#          script: |
#            curl -X POST ${{ env.TEST_SERVER }}/trigger-tests \
#              --header "Content-Type: application/json" \
#              --header "X-Webhook-Secret: ${{ secrets.INTERGRATION_TEST_WEBHOOK_SECRET }}" \
#              --data '{
#                "stagingUrl": "http://ev-hub-network:8080",
#                "prNumber": "${{ github.event.pull_request.number }}",
#                "commitSha": "${{ github.sha }}"
#              }'

  notify_result:
    needs: [ deploy ]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Notify Success
        if: success()
        uses: ./.github/actions/notify-discord
        with:
          content: "‚úÖ [UAT] ${{ env.PROJECT_NAME }} Deployment successful! New version running."
          bot_token: ${{ secrets.DISCORD_TOKEN }}
          channel: ${{ secrets.DISCORD_CHANNEL }}

      - name: Notify Failure
        if: failure()
        uses: ./.github/actions/notify-discord
        with:
          content: "‚ùå [UAT] ${{ env.PROJECT_NAME }} Deployment failed at step: ${{ github.job }}."
          bot_token: ${{ secrets.DISCORD_TOKEN }}
          channel: ${{ secrets.DISCORD_CHANNEL }}
